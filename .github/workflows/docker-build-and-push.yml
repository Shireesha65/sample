name: Docker ECR Workflow

on:
  push:
    branches:
      - new
      - main
  pull_request:
    branches:
      - new
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: |
          ~/.docker
        key: ${{ runner.os }}-docker-${{ hashFiles('**/*.lock') }}
        restore-keys: |
          ${{ runner.os }}-docker-

    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }} 
        AWS_REGION: "us-east-1"
      run: |
        echo $ECR_REGISTRY | docker login -u AWS --password-stdin $ECR_REGISTRY

        docker buildx create --use
        docker buildx inspect --bootstrap

        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$GITHUB_SHA \
          --push .

  # Add additional jobs or steps as needed.
